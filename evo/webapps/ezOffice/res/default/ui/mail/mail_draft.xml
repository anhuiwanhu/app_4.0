<?xml version="1.0" encoding="utf-8"?>
<imag>
    <script>
        <![CDATA[
            var storage = $phone.localStorage();
			var arrId = new Array();
            var deMailid = "";
            var curpage = '1';
            var itemState='0';
            var disp='0';
            var addMore='0';
            var evoUrl = storage.getItem('evoUrl');
            var userId = storage.getItem('sys_sys_userId');
            $page.onload=function(){
				$('indexContent').hideBottom(); 
				//updateCache();
				CacheDataToPage();
				$page.setTimeout(function() {
	        	   hint('列表自动刷新中...');
	        	   updateCache2();
                }, 2000);
            }
            
            function showDe(){
            	$('indexContent').draggable='false';
            	$('ovewshow').css('display', 'none');
            	$('foot').css('display', 'block');
            	$('editshow').css('display', 'block');
            	itemState='1';
                for(var i=0;i<arrId.length;i++){
           			$('ite'+arrId[i]).update('chData', {style:'display:'+"block"});
                }
                if(disp=='1'){
            		$('bottom_more').css('display','none');
	                $('bottom_load').css('display','none');
            	}
            }
            
            function showLi(){
            	$('indexContent').draggable='true';
            	$('editshow').css('display', 'none');
            	$('foot').css('display', 'none');
            	$('ovewshow').css('display', 'block');
            	itemState='0';
                for(var i=0;i<arrId.length;i++){
            		$('ite'+arrId[i]).update('chData', {style:'display:'+"none"});
            		$('ite'+arrId[i]).update('chData', {src:'mail_uncheck.png'});
            		deMailid="";
                }
                if(disp=='1'){
            		$('bottom_more').css('display','block');
	                $('bottom_load').css('display','none');
            	}
            }
            
            function addIds(mailid){
               var sr = $('ite' + mailid).getWidgetAttribute('chData', 'src');
               if(sr=="mail_uncheck.png"){
                  deMailid = deMailid+"("+mailid+"),";
                  $('ite'+mailid).update('chData', {src:'mail_check.png'});
               }else{
               	  deMailid = deMailid.replace("("+mailid+"),","");
               	  $('ite'+mailid).update('chData', {src:'mail_uncheck.png'});
               }
            }
            
            function deMail(){
                if(deMailid ==null|| deMailid==''){
                	alert("请至少选择一封邮件进行删除！");
                    return;
                }else{
                	$http.post(evoUrl+'/ezOffice/mail/deldrMail.do', 
					{mailids:deMailid}, function(data){
						var obj = JSON.parse(data);
						var result = obj.message.result;
						if(result =="1"){
							alert("邮件删除成功!");
							$page.open('mail_draft.xml',{target:'_self'}); 
						}else{
							alert("邮件删除失败!");
							$page.open('mail_draft.xml',{target:'_self'}); 
						}
					},function(error) {
						toErro(error);
					});
                }
            }
         
         	function toView(mailId){
				if(itemState=='0'){
					storage.setItem('mail_drMailid',mailId);
					$page.open('drmail_view.xml',{animation:'down-to-up'});
				}else{
					addIds(mailId);
				}
			}
         
         	function openPopupMenu() {
                $('popmenu').open();
                $('arrow').src = 'mail_up.png'; 
            }
			
			function refresh(){
				if(addMore=='1'){
					return;
				}
				addMore='1';
				if(curpage=="1"){
					$('mailList').clear();
					arrId = new Array();
				}
				$http.post(evoUrl+'/ezOffice/mail/drListdate.do', 
					{curpage:curpage,subject:$('subject').value}, function(data) {
					var obj = JSON.parse(data);
					var result = obj.message.result;
					var listJson = {items:[]};
					if(result =="1"){
						var recordCount = obj.data.recordCount;
						if(parseInt(recordCount) <=0){
							var itemJson = {
			                    template : 2,
			                    onclick : '',
			                    widgets : {
			                        title : {text :'暂无相关记录'}
			                    }
			                }
			                listJson.items.push(itemJson);
							$('mailList').update(listJson);
							$('indexContent').hideBottom();
							$('indexContent').hideTop();
							addMore='0';
						}else{
							var pageCount = obj.data.pageCount;
			                var list = obj.data.list;
			                if(list instanceof Array){
		                		for(var i=0;i<list.length;i++){
		                			arrId.push(list[i].mailid);
		                			var mailposttime = list[i].mailposttime;
				                    if(mailposttime!=null&&mailposttime.length>20){
				                        mailposttime = mailposttime.substring(0,16);
				                    }
				                    var mailsubject = list[i].mailsubject+"";
				                    if(mailsubject==null || mailsubject==''){
				                       mailsubject="无主题";
				                    }
		                			if(list[i].accessorySize=="0"){
		                				var itemJson = {
						                    template : 0,
						                    id : 'ite'+list[i].mailid,
						                    onclick : 'toView("'+list[i].mailid+'")',
						                    widgets : {
						                        chData : {onclick:'addIds("'+list[i].mailid+'");',src:'mail_uncheck.png'},
						                        cont : {text:mailsubject},
						                        time : {text:mailposttime}
						                    }
						                }
						                listJson.items.push(itemJson);
		                			}else{
		                				var itemJson = {
						                    template : 1,
						                    id : 'ite'+list[i].mailid,
						                    onclick : 'toView("'+list[i].mailid+'")',
						                    widgets : {
						                        chData : {onclick:'addIds("'+list[i].mailid+'");',src:'mail_uncheck.png'},
						                        cont : {text:mailsubject},
						                        time : {text:mailposttime}
						                    }
						                }
						                listJson.items.push(itemJson);
		                			}
		                		}
		                	}else if(list instanceof Object){
		                		arrId.push(list.mailid);
		                		var mailposttime = list.mailposttime;
			                    if(mailposttime!=null&&mailposttime.length>20){
			                        mailposttime = mailposttime.substring(0,16);
			                    }
			                    var mailsubject = list.mailsubject+"";
			                    if(mailsubject==null || mailsubject==''){
			                       mailsubject="无主题";
			                    }
		                		if(list.accessorySize=="0"){
	                				var itemJson = {
					                    template : 0,
					                    id : 'ite'+list.mailid,
					                    onclick : 'toView("'+list.mailid+'")',
					                    widgets : {
					                        chData : {onclick:'addIds("'+list.mailid+'");',src:'mail_uncheck.png'},
					                        cont : {text:mailsubject},
					                        time : {text:mailposttime}
					                    }
					                }
					                listJson.items.push(itemJson);
	                			}else{
	                				var itemJson = {
					                    template : 1,
					                    id : 'ite'+list.mailid,
					                    onclick : 'toView("'+list.mailid+'");',
					                    widgets : {
					                        chData : {onclick:'addIds("'+list.mailid+'");',src:'mail_uncheck.png'},
					                        cont : {text:mailsubject},
					                        time : {text:mailposttime}
					                    }
					                }
					                listJson.items.push(itemJson);
	                			}
		                	}
			                $('mailList').addMore(listJson);
		                	if(parseInt(curpage) < parseInt(pageCount)){
	                			$('bottom_more').css('display','block');
	                			$('bottom_load').css('display','none');
	                			disp='1';
		                	}else{
		                		$('indexContent').hideBottom();
		                		disp='0';
		                	}
		                	$('indexContent').hideTop();
							addMore='0';
						}
					}else{
						var itemJson = {
		                    template : 2,
		                    onclick : '',
		                    widgets : {
		                        title : {text :'暂无相关记录'}
		                    }
		                }
		                listJson.items.push(itemJson);
						$('mailList').update(listJson);
						$('indexContent').hideBottom();
						$('indexContent').hideTop();
						addMore='0';
					}
		   		},function(error) {
					toErro(error);
				});
			}
			
			function downfrsh(){
				curpage = parseInt(curpage)+1+"";
				$('bottom_more').css('display','none');
	            $('bottom_load').css('display','block');
				refresh();
			}
			
			function searchMail(){
				$('bottom_more').css('display','none');
	            $('bottom_load').css('display','block');
				curpage = '1';
				refresh();
			}
			function upfrsh(){
		   		$('bottom_more').css('display','none');
	            $('bottom_load').css('display','none');
	            $('indexContent').showBottom();
		   		curpage = '1';
				if($('subject').value==''){
		   			updateCache2();
		   		}else{
		   			refresh();
		   		}
		   }
		   
		   function toErro(error){
				if (error == 'timeout') {
					hint('连接服务器超时！');
				} else if (error == '404') {
					hint('链接超时重新登录！');
				} else if (error == '500') {
					hint('内部服务器错误！');
				} else {
					hint('访问网络错误！错误代码:' + error);
				}
			}
			
			//缓存无数据则更新
	        function updateCache(){
			      var dbName = storage.getItem('ezMobile_dbName');
       	    	  var db = $phone.openDatabase(dbName);
			      db.transaction(queryHasDataDB, function(err){alert(err);}, function(){});
			      function queryHasDataDB(tx) {
					tx.executeSql('select mailid from mail_data where mailType="draft" and userId="'+userId+'"',[],
						function(results){
							  if(results.rows!=null && results.rows.length>0){
							     CacheDataToPage();
							  }else{
							     updateCache2();
							  }
						} , function(err){alert(err);}); 
			      }
	        }
	        
	        //更新缓存数据并刷新页面
	        function updateCache2(){
	           $http.post(
	       			evoUrl+'/ezOffice/mail/drListdate.do', 
			        {currPage : '1'}, 
			        function(data) {
			            var obj = JSON.parse(data);
			            if(obj){
			        	  DbToCacheData(obj);
			        	  CacheDataToPage();
			        	}
			        	
			        },function(error) {
				    if (error == 'timeout') {
						hint('连接服务器超时！');
				    } else if (error == '404') {
						hint('链接超时重新登录！');
				    } else if (error == '500') {
						hint('内部服务器错误！');
				    } else {
						hint('访问网络错误！错误代码:' + error);
				    }
				  }
				    
			  );
	        }
	        
	        //将获取到的数据存入缓存
	        function DbToCacheData(obj) {
		       var dbName = storage.getItem('ezMobile_dbName');
       	       var db = $phone.openDatabase(dbName);
		       db.transaction(DbToCacheData_1);
		       function DbToCacheData_1(tx) {
			        tx.executeSql('delete from mail_data where mailType="draft" and userId="'+userId+'"');
			        var result = obj.message.result;
	        		if(result == '1'){
	        			var recordCount = obj.data.recordCount;
						if(parseInt(recordCount) >0){
		                	var list = obj.data.list;
		                	var hasMore='0';
		                	var pageCount = obj.data.pageCount;
		                	if(parseInt(pageCount)>1){
		                		hasMore='1';
		                	}
		                	if(list instanceof Array){
		                		for(var i=0;i<list.length;i++){
		                			var mailid = list[i].mailid;
		                			var mailposttime = list[i].mailposttime;
				                    if(mailposttime!=null&&mailposttime.length>20){
				                        mailposttime = mailposttime.substring(0,16);
				                    }
				                    var mailsubject = list[i].mailsubject+"";
				                    if(mailsubject==null || mailsubject==''){
				                       mailsubject="无主题";
				                    }
				                    var accessorySize = list[i].accessorySize;
				                    var dealfile_sql = 'insert into mail_data(mailid,mailuserid,read,photo,notRead,mailposttime,mailpostername,mailsubject,accessorySize,mailType,userId,hasMore) '+
	        							' values("'+mailid+'","","","","","'+mailposttime+'","","'+mailsubject+'","'+accessorySize+'","draft","'+userId+'","'+hasMore+'")';
	        						tx.executeSql(dealfile_sql);
		                		}
		                	}else if(list instanceof Object){
		                			var mailid = list.mailid;
		                			var mailposttime = list.mailposttime;
				                    if(mailposttime!=null&&mailposttime.length>20){
				                        mailposttime = mailposttime.substring(0,16);
				                    }
				                    var mailsubject = list.mailsubject+"";
				                    if(mailsubject==null || mailsubject==''){
				                       mailsubject="无主题";
				                    }
				                    var accessorySize = list.accessorySize;
				                    var dealfile_sql = 'insert into mail_data(mailid,mailuserid,read,photo,notRead,mailposttime,mailpostername,mailsubject,accessorySize,mailType,userId,hasMore) '+
	        							' values("'+mailid+'","","","","","'+mailposttime+'","","'+mailsubject+'","'+accessorySize+'","draft","'+userId+'","'+hasMore+'")';
	        						tx.executeSql(dealfile_sql);
		                	}
						}else{
							noDataContent();
						}
	        		}else{
	        			//查询数据异常
	        			noDataContent();
	        		}
			   }
		    }
	        
	        //没有查到数据或者数据查询异常时
	        function noDataContent(){
	        	var listJson = {items:[]};
	        	var itemJson = {
                    template : 2,
                    onclick : '',
                    widgets : {
                        title : {text :'暂无相关记录'}
                    }
                }
                listJson.items.push(itemJson);
				$('mailList').update(listJson);
				$('indexContent').hideBottom();
	        }
	        
		    //将缓存数据更新到页面
		    function CacheDataToPage(){
	        	  $('mailList').clear();
	        	  arrId = new Array();
			      var dbName = storage.getItem('ezMobile_dbName');
       	    	  var db = $phone.openDatabase(dbName);
			      db.transaction(queryDealfileListDB, function(err){alert(err);}, function(){});
			      function queryDealfileListDB(tx) {
					tx.executeSql('select mailid,mailposttime,mailsubject,accessorySize,hasMore from mail_data where mailType = "draft" and userId = "'+userId+'"',[],
						function(results){
							  if(results.rows!=null && results.rows.length>0){
							  	var listJson = {items:[]};
							    for(var i=0; i<results.rows.length; i++){
								      var mailid = results.rows.item(i).mailid;
								      var mailposttime = results.rows.item(i).mailposttime;
								      var mailsubject = results.rows.item(i).mailsubject;
								      var accessorySize = results.rows.item(i).accessorySize;
								      arrId.push(mailid);
								      if(accessorySize=="0"){
								      	var itemJson = {
						                    template : 0,
						                    id : 'ite'+mailid,
						                    onclick : 'toView("'+mailid+'")',
						                    widgets : {
						                        chData : {onclick:'addIds("'+mailid+'");',src:'mail_uncheck.png'},
						                        cont : {text:mailsubject},
						                        time : {text:mailposttime}
						                    }
						                }
						                listJson.items.push(itemJson);
								      }else{
								      	var itemJson = {
						                    template : 1,
						                    id : 'ite'+mailid,
						                    onclick : 'toView("'+mailid+'")',
						                    widgets : {
						                        chData : {onclick:'addIds("'+mailid+'");',src:'mail_uncheck.png'},
						                        cont : {text:mailsubject},
						                        time : {text:mailposttime}
						                    }
						                }
						                listJson.items.push(itemJson);
								      }
							    }
							  $('mailList').addMore(listJson);
							  var hasMore = results.rows.item(0).hasMore;
							  if(hasMore=='1'){
							  	 $('indexContent').showBottom();
							  	 $('bottom_more').css('display','block');
	                			 $('bottom_load').css('display','none');
							  }else{
							  	 $('indexContent').hideBottom();
							  }
							  $('indexContent').hideTop();
							}else{
								noDataContent();
							}
						} , function(err){alert(err);}); 
			      }
	        }
        ]]>
    </script>
    <page>
        <popupmenu id="popmenu" position="topcenter" onclose="$('arrow').src = 'mail_down.png';" style="width:130">
            <list>
                <item onclick="$('popmenu').close();$page.open('mail_receive.xml',{target:'_self'});" style="background:#3daffe,#474747">
                    <row>
                        <label style="margin-left:15;font-size:18;color:white;">收件箱</label>
                    </row>
                </item>
                <item onclick="$('popmenu').close();$page.open('mail_send.xml',{target:'_self'});" style="background:#3daffe,#474747">
                    <row>
                        <label style="margin-left:15;font-size:18;color:white;">发件箱</label>
                    </row>
                </item>
                <item onclick="$('popmenu').close();$page.open('mail_draft.xml',{target:'_self'});" style="background:#3daffe,#474747">
                    <row>
                        <label style="margin-left:15;font-size:18;color:white;">草稿箱</label>
                        <icon src="top_updown.png" style="align:right;width:15;"></icon>
                    </row>
                </item>
            </list>
		</popupmenu> 
        <title style="background:#38adff;tint-color:white">
            <left>
                <button role="back"></button>
            </left>
            <center>
                <label onclick="openPopupMenu();">草稿箱</label>
                <icon id="arrow" src="mail_down.png" style="width:15;margin-left:5;" onclick="openPopupMenu();"></icon>
            </center>
            <right>
               <button onclick="$page.open('mail_write.xml',{animation:'down-to-up'});" icon="desk_personcenter_add.png"></button>
            </right>
        </title>
        <header style="margin-top:0">
          <row>
              <input type="search" onclick="searchMail();" id="subject" placeholder="搜索邮件主题" style="height:40"/>
              <button id="ovewshow" onclick="showDe();" style="background:#E7E7E7;height:35;color:#b8b8b8;margin-left:5;font-size:14;corner-radius:8;">编辑</button>
              <button id="editshow" onclick="showLi();" style="background:#E7E7E7;height:35;color:#b8b8b8;font-size:14;margin-left:5;corner-radius:8;display:none">完成</button>
          </row>
		</header>
        <content id="indexContent" draggable="true" ondragdown="upfrsh();">
            <list id="mailList" reuse="true">
                <item style="col-width:25,*">
                    <col>
                        <icon reusekey="chData" style="display:none;width:20;height:20"></icon>
                    </col>
                    <col>
                        <label reusekey="cont" style="color:#555555;font-size:16"></label>
                        <label reusekey="time" style="color:#b8b8b8;font-size:12"></label>
                    </col>
                </item>
                <item style="col-width:25,20,*">
                    <col>
                        <icon reusekey="chData" style="display:none;width:20;height:20"></icon>
                    </col>
                    <col>
                        <icon src="mail_fujian.png"></icon>
                    </col>
                    <col>
                        <label reusekey="cont" style="color:#555555;font-size:16"></label>
                        <label reusekey="time" style="color:#b8b8b8;font-size:12"></label>
                    </col>
                </item>
                <item>
                   <col><row><label reusekey="title" style="align:center;"></label></row></col>
                </item>
            </list>
            <bottom id="bottom" style="display:block">
	            <list>
	                <item onclick="downfrsh();" style="background:null,#DEE3E7">
	                    <row id="bottom_load">
		                    <label style="align:center;">正在加载...</label>
		                    <progress style="align:center"/>
	                    </row>
	                    <row id="bottom_more" style="display:none">
	                        <label style="align:center;">点击加载更多...</label>
	                        <progress id="globalProgress" style="display:hidden;align:center;"/>
	                    </row>
	                </item>
	            </list>
	        </bottom>
        </content>
        <footer id="foot" style="display:none;background:#cac9ce">
            <button icon="mail_dele.png" onclick="deMail();" style="align:center;color:#FF3300;font-size:16;height:50;border:0 white">  删除</button>
        </footer>
    </page>
</imag>
