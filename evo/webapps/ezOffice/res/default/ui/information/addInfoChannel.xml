<?xml version="1.0" encoding="utf-8"?>
<imag mode="develop">
    <script>
    <![CDATA[
        var loadFlag = '0';  //函数执行置为1，提交之前进行判断，若为1，则禁止 提交，防重复提交
        var selectChannels="";
        var evoUrl = "";
		$page.onload = function() {
			var storage = $phone.localStorage();
            var userAccount = storage.getItem('userAccount');
            evoUrl = storage.getItem('evoUrl');
            loadMychannel();	   
			getCannelInfo();
		}
		function getCannelInfo() {
		   var title = $('title').value;
		   $('content').clear();
		   $http.post(evoUrl+'/ezOffice/information/getInfoChannel.do',{title:title}, function(data) {
			     var obj = JSON.parse(data);
			     if(obj.message.result=="1"){
                    var groups = obj.data.infomationChannel;
                    if(groups instanceof Array){
				        for(var i=0;i<groups.length;i++){
				          var channelId = groups[i].channelId;
				          var channelName = groups[i].channelName;
	                      var isCanAdd = groups[i].isCanAdd;
	                      var channelNeedCheckup = groups[i].channelNeedCheckup;
	                      if(isCanAdd==null||isCanAdd==''){
	                      		isCanAdd = '';
	                      }
	                      if(channelNeedCheckup==null||channelNeedCheckup==''){
	                      		channelNeedCheckup = '';
	                      }
	                      var  isAddBtn = isCanAdd+','+channelNeedCheckup;   //拼接isCanAdd，channelNeedCheckup，下级栏目和栏目列表时使用
				          if((i%6)==0){
				            var btncolor = "#f98e75";
				          }else if((i%6)==1){
				            var btncolor = "#f6d75b";
				          }else if((i%6)==2){
				            var btncolor = "#6fd5ff";
				          }else if((i%6)==3){
				            var btncolor = "#9cc2ff";
				          }else if((i%6)==4){
				            var btncolor = "#93df88";
				          }else if((i%6)==5){
				            var btncolor = "#d795ea";
				          }
				          var firstname = channelName.substring(0,1);
				           var acc = "";
				           var hasacc="";
	                       if(groups[i].child.length>0){
	                          acc = "forum_opendown.png";
	                          hasacc="opencloseMenu(this,'icon_"+channelId+"')";
	                       }
	                       var hasChek = "";
	                       if(selectChannels.indexOf("|"+channelId+"|")>-1){
		                       if(channelIdArr.indexOf("id_"+channelId)>-1){   //处理页面刚进入时，会自动出发checkbox中的onclick
					            	return;
					           }else{
					                channelIdArr.push("id_"+channelId);
					           }
	                          hasChek = " checked=\"true\" ";
	                       }
	                       if(groups[i].isView == '1'){
		                       $('content').add($C('<list>'+
									'<item id="'+channelId+'" collapsed="true" indent="30" onclick="'+hasacc+';">'+
										'<row>'+
											'<checkbox style="align:left;font-size:18" id="id_'+channelId+'" value="'+channelName+'" name="'+isAddBtn+'" onclick="getCheckedInfo(\''+channelId+'\')" '+hasChek+'/>'+
											'<button style="width:40;height:40;align:left;font-size:16;color:#ffffff;background:'+btncolor+'" onclick=";">'+firstname+'</button>'+
											'<label style="align:left;margin:10;color:#555555;font-size:16;">'+channelName+'</label>'+
											'<icon id="icon_'+channelId+'" role="accessory" src="'+acc+'" style="align:right;margin:2 5%;"/>'+
										'</row>'+
										createItem(groups[i].child)+
									'</item>'+
								'</list>'));
	                       }else{
	                       		$('content').add($C('<list>'+
									'<item id="'+channelId+'" collapsed="true" indent="30" onclick="'+hasacc+';">'+
										'<row>'+
											'<button style="width:40;height:40;align:left;font-size:16;color:#ffffff;background:'+btncolor+'" onclick=";">'+firstname+'</button>'+
											'<label style="align:left;margin:10;color:#555555;font-size:16;">'+channelName+'</label>'+
											'<icon id="icon_'+channelId+'" role="accessory" src="'+acc+'" style="align:right;margin:2 5%;"/>'+
										'</row>'+
										createItem(groups[i].child)+
									'</item>'+
								'</list>'));
	                       }
	                       
				        }
			        
			        }else if(groups instanceof Object){
				          var channelId = groups.channelId;
				          var channelName = groups.channelName;
	                      var isCanAdd = groups.isCanAdd;
	                      var channelNeedCheckup = groups.channelNeedCheckup;
	                      if(isCanAdd==null||isCanAdd==''){
	                      		isCanAdd = '';
	                      }
	                      if(channelNeedCheckup==null||channelNeedCheckup==''){
	                      		channelNeedCheckup = '';
	                      }
	                      var  isAddBtn = isCanAdd+','+channelNeedCheckup;   //拼接isCanAdd，channelNeedCheckup，下级栏目和栏目列表时使用
                          var btncolor = "#f98e75";
				          var firstname = channelName.substring(0,1);
				           var acc = "";
				           var hasacc="";
	                       var hasChek = "";
	                       if(selectChannels.indexOf("|"+channelId+"|")>-1){
	                           if(channelIdArr.indexOf("id_"+channelId)>-1){   //处理页面刚进入时，缓存中存在，将之存入数组中，并且判断数组中是否已经存在，已存在，不要再放入
					           }else{
					                channelIdArr.push("id_"+channelId);
					           }
	                          hasChek = " checked=\"true\" ";
	                       }
	                       if(groups.isView == '1'){
	                       		$('content').add($C('<list>'+
									'<item id="'+channelId+'" collapsed="true" indent="30" onclick="'+hasacc+';">'+
										'<row>'+
											'<checkbox style="align:left;font-size:18" id="id_'+channelId+'" value="'+channelName+'" name="'+isAddBtn+'" onclick="getCheckedInfo(\''+channelId+'\')" '+hasChek+'/>'+
											'<button style="width:40;height:40;align:left;font-size:16;color:#ffffff;background:'+btncolor+'" onclick=";">'+firstname+'</button>'+
											'<label style="align:left;margin:10;color:#555555;font-size:16;">'+channelName+'</label>'+
											'<icon id="icon_'+channelId+'" role="accessory" src="'+acc+'" style="align:right;margin:2 5%;"/>'+
										'</row>'+
									'</item>'+
								'</list>'));
	                       }else{
	                       		$('content').add($C('<list>'+
									'<item id="'+channelId+'" collapsed="true" indent="30" onclick="'+hasacc+';">'+
										'<row>'+
											'<button style="width:40;height:40;align:left;font-size:16;color:#ffffff;background:'+btncolor+'" onclick=";">'+firstname+'</button>'+
											'<label style="align:left;margin:10;color:#555555;font-size:16;">'+channelName+'</label>'+
											'<icon id="icon_'+channelId+'" role="accessory" src="'+acc+'" style="align:right;margin:2 5%;"/>'+
										'</row>'+
									'</item>'+
								'</list>'));
	                       }
	                       
			        }
			     }
			     $('lab_saveMychannel').onclick='saveMychannel();';
			},function(error) {
			    if (error == 'timeout') {
			        hint('连接服务器超时！');
			    } else if (error == '404') {
			        hint('链接超时重新登录！');
			    } else if (error == '500') {
			        hint('内部服务器错误！');
			    } else {
			        hint('访问网络错误！错误代码:' + error);
			    }
		    });
		}

	   function createItem(groups){
			if(groups){
				var itemStr = '';
				for(var i =0;i<groups.length;i++){
				      var channelId = groups[i].channelId;
			          var channelName = groups[i].channelName;
			          var isCanAdd = groups[i].isCanAdd;
                      var channelNeedCheckup = groups[i].channelNeedCheckup;
                      if(isCanAdd==null||isCanAdd==''){
                      		isCanAdd = '';
                      }
                      if(channelNeedCheckup==null||channelNeedCheckup==''){
                      		channelNeedCheckup = '';
                      }
                      var  isAddBtn = isCanAdd+','+channelNeedCheckup;   //拼接isCanAdd，channelNeedCheckup，下级栏目和栏目列表时使用
                      
			          if((i%6)==0){
			            var btncolor = "#f98e75";
			          }else if((i%6)==1){
			            var btncolor = "#f6d75b";
			          }else if((i%6)==2){
			            var btncolor = "#6fd5ff";
			          }else if((i%6)==3){
			            var btncolor = "#9cc2ff";
			          }else if((i%6)==4){
			            var btncolor = "#93df88";
			          }else if((i%6)==5){
			            var btncolor = "#d795ea";
			          }
			          var firstname = channelName.substring(0,1);
			          var acc = "";
			          var hasacc="";
                       if(groups[i].child.length>0){
                          acc = "forum_opendown.png";
                          hasacc= "opencloseMenu(this,'icon_"+channelId+"')";
                       }
                       
                       var hasChek = "";
                       if(selectChannels.indexOf("|"+channelId+"|")>-1){
	                      if(channelIdArr.indexOf("id_"+channelId)>-1){   //处理页面刚进入时，缓存中存在，将之存入数组中，并且判断数组中是否已经存在，已存在，不要再放入
				            	
				          }else{
				                channelIdArr.push("id_"+channelId);
				          }
                          hasChek = " checked=\"true\" ";
                       }
			          
					itemStr += '<item id="'+channelId+'" collapsed="true" indent="30" onclick="'+hasacc+';" >';
					if(groups[i].isView == '1'){
						itemStr += '<row>'+
									'<checkbox style="align:left;font-size:18" id="id_'+channelId+'" value="'+channelName+'" name="'+isAddBtn+'" onclick="getCheckedInfo(\''+channelId+'\')" '+hasChek+'/>'+
									'<button style="width:120;width:40;height:40;align:left;color:#ffffff;font-size:16;background:'+btncolor+'" onclick=";">'+firstname+'</button>'+
									'<label style="align:left;margin:10 10;color:#555555;font-size:16;">'+channelName+'</label>'+
									'<icon id="icon_'+channelId+'" role="accessory" src="'+acc+'" style="align:right;margin:2 5%;"/>'+
								'</row>'+
								createItem(groups[i].child)+
	                    '</item>';
	                 }else{
	                 	itemStr += '<row>'+
									'<button style="width:120;width:40;height:40;align:left;color:#ffffff;font-size:16;background:'+btncolor+'" onclick=";">'+firstname+'</button>'+
									'<label style="align:left;margin:10 10;color:#555555;font-size:16;">'+channelName+'</label>'+
									'<icon id="icon_'+channelId+'" role="accessory" src="'+acc+'" style="align:right;margin:2 5%;"/>'+
								'</row>'+
								createItem(groups[i].child)+
	                    '</item>';
	                 }
				}
				return itemStr;
			}
	    }
	    function opencloseMenu(obj,ic){
	       //alert(obj.collapsed);
	       if(obj.collapsed){
	         $(ic).src="forum_opendown.png";
	       }else{
	         $(ic).src="forum_openup.png";
	       }
	    }
        var elements = new Array();
        var channelIdArr = new Array();
        function getCheckedInfo(channelId){
         //   alert($("id_"+channelId).checked);
            if($("id_"+channelId).checked==true){
               if(channelIdArr.indexOf("id_"+channelId)>-1){   //处理页面刚进入时，会自动出发checkbox中的onclick
	            	return;
	           }else{
	                channelIdArr.push("id_"+channelId);
	           }
            }else{
               var index = channelIdArr.indexOf("id_"+channelId);
			   if (index > -1) {
			   		channelIdArr.splice(index, 1);
			   }
            }
        }
        
        function putCacheToEleArr(){   //已经选中的栏目，增加到elements数组中
            if(channelIdArr.length>0){
            	for (var i = 0; i < channelIdArr.length; i++) {
		             elements.push($(channelIdArr[i]));
            	}
            }
        }
	    function saveMychannel(){
	        if(loadFlag == '1'){
	        	return false;
	        }
	        loadFlag = '1';
	        putCacheToEleArr();   //获取elements对象数组
	      // var elements = $('addForm').elements;
	       var storage = $phone.localStorage();
           var dbName = storage.getItem('ezMobile_dbName');
            var db = $phone.openDatabase(dbName);
		    db.transaction(populateDB, function(err){alert(err);}, function(){});
		    function populateDB(tx) {
		        tx.executeSql('delete from myInfoChannel');
		        for (var i = 0; i < elements.length; i++) {
	                var element = elements[i];
	                if (element instanceof CheckBox && element.checked) {
	                    var channel_id = element.id;
	                    var channelId = channel_id.substring(3,channel_id.length);
	                    var channelName = element.value;
	                    var isAddBtn = element.name;
	                    var isAddBtnArr = isAddBtn.split(',');
	                    var isCanAdd = '';
	                    var channelNeedCheckup = '';
	                    if(isAddBtnArr.length==2){
	                        isCanAdd = isAddBtnArr[0];
	                        channelNeedCheckup = isAddBtnArr[1];
	                    }
	                    var sql='INSERT INTO myInfoChannel (channelId,channelName,isCanAdd,channelNeedCheckup) VALUES ("'+channelId+'","'+element.value+'","'+isCanAdd+'","'+channelNeedCheckup+'")';
	                    //alert(sql);
	                    tx.executeSql(sql);
	                }
	            }
		    }
		    loadFlag = '0';
		    $page.close(-1);
		    $page.open('../desktop.xml?showTab=pubtab', {animation:'down-to-up',target:'_self'});

        }
        function loadMychannel(){
            var storage = $phone.localStorage();
            var dbName = storage.getItem('ezMobile_dbName');
            var db = $phone.openDatabase(dbName);
		    db.transaction(queryDB, function(err){alert(err);}, function(){});
		    function queryDB(tx) {
		        tx.executeSql('select channelId,channelName from myInfoChannel ',[],
						function(results){
						  if(results.rows!=null && results.rows.length>0){
							    for(var i=0; i<results.rows.length; i++){
							      var _channelId = results.rows.item(i).channelId;
							      selectChannels += "|"+_channelId+"|";
							    }
						   
						   }
						} , function(err){alert(err);});  
		    }
		    //alert(selectChannels);
        }
        
		function searchColumn(){
			 var title = $('title').value;
			  $('content').clear();
			 if(title ==''){
			 	getCannelInfo();
			 }else{
			 	getSearch(title);
			 }
		}
		
		
		function getSearch(title){
			 $http.post(evoUrl+'/ezOffice/information/searchChannel.do',{title:title}, function(data) {
			     var obj = JSON.parse(data);
			     var result = obj.message.result;
			     if(result =="1"){
			     	var objArr = obj.data.informationChannel; //返回列表数组
			     	if(objArr instanceof Array){
			     		for(var i=0;i<objArr.length;i++){
			     			var channelId = objArr[i].channelId;
				     	    var channelName =  objArr[i].channelName;
				     	    var hasChek = 'false';
		                    var channelId = objArr[i].channelId;
		                    if(selectChannels.indexOf("|"+channelId+"|")>-1){
		                          if(channelIdArr.indexOf("id_"+channelId)>-1){   //处理页面刚进入时，缓存中存在，将之存入数组中，并且判断数组中是否已经存在，已存在，不要再放入
						            	
						          }else{
						                channelIdArr.push("id_"+channelId);
						          }
		                          hasChek = "true";
		                    }
		                    var isCanAdd = objArr[i].isCanAdd;
	                        var channelNeedCheckup = objArr[i].channelNeedCheckup;
	                        if(isCanAdd==null||isCanAdd==''){
	                      		isCanAdd = '';
	                        }
	                        if(channelNeedCheckup==null||channelNeedCheckup==''){
	                      		channelNeedCheckup = '';
	                        }
	                        var  isAddBtn = isCanAdd+','+channelNeedCheckup;   //拼接isCanAdd，channelNeedCheckup，下级栏目和栏目列表时使用
	                        var firstname = channelName.substring(0,1);
	                        var style = '';
		                    if((i%6)==0){
		                         style = 'width:120;background:#f98e75;width:40;height:40;align:left;font-size:16;color:#ffffff;';
		                    }else if((i%6)==1){
		                         style = 'width:120;background:#f6d75b;width:40;height:40;align:left;font-size:16;color:#ffffff;';
		                    }else if((i%6)==2){
		                         style = 'width:120;background:#6fd5ff;width:40;height:40;align:left;font-size:16;color:#ffffff;';
		                    }else if((i%6)==3){
		                         style = 'width:120;background:#9cc2ff;width:40;height:40;align:left;font-size:16;color:#ffffff;';
		                    }else if((i%6)==4){
		                         style = 'width:120;background:#93df88;width:40;height:40;align:left;font-size:16;color:#ffffff;';
		                    }else if((i%6)==5){
		                         style = 'width:120;background:#d795ea;width:40;height:40;align:left;font-size:16;color:#ffffff;';
		                    }
				     	    $('content').add($C('<list>'+
								'<item id="'+channelId+'" collapsed="true" indent="30">'+
									'<row>'+
                                        '<checkbox  style="align:left;font-size:18;" id="id_'+channelId+'" value="'+channelName+'" name="'+isAddBtn+'" checked="'+hasChek+'" onclick="getCheckedInfo(\''+channelId+'\')" />'+
										'<button style="'+style+'" onclick=";">'+firstname+'</button>'+
										'<label style="align:left;margin:5;font-size:16;color:#555555;">'+channelName+'</label>'+
									'</row>'+
								'</item>'+
							'</list>'));
			     		}
			     	}else if(objArr instanceof Object){
			     	    var channelId = objArr.channelId;
			     	    var channelName =  objArr.channelName;
			     	    var hasChek = 'false';
	                    var channelId = objArr.channelId;
	                    if(selectChannels.indexOf("|"+channelId+"|")>-1){
	                          if(channelIdArr.indexOf("id_"+channelId)>-1){   //处理页面刚进入时，缓存中存在，将之存入数组中，并且判断数组中是否已经存在，已存在，不要再放入
					            
					          }else{
					                channelIdArr.push("id_"+channelId);
					          }
	                          hasChek = "true";
	                    }
	                    var isCanAdd = objArr.isCanAdd;
                        var channelNeedCheckup = objArr.channelNeedCheckup;
                        if(isCanAdd==null||isCanAdd==''){
                      		isCanAdd = '';
                        }
                        if(channelNeedCheckup==null||channelNeedCheckup==''){
                      		channelNeedCheckup = '';
                        }
                        var  isAddBtn = isCanAdd+','+channelNeedCheckup;   //拼接isCanAdd，channelNeedCheckup，下级栏目和栏目列表时使用
                        var firstname = channelName.substring(0,1);
                        var style = 'width:120;background:#f98e75;width:40;height:40;align:left;font-size:16;color:#ffffff;';
			     	    $('content').add($C('<list>'+
								'<item id="'+channelId+'" collapsed="true" indent="30">'+
									'<row>'+
                                        '<checkbox  style="align:left;font-size:18;" id="id_'+channelId+'" value="'+channelName+'" name="'+isAddBtn+'" checked="'+hasChek+'" onclick="getCheckedInfo(\''+channelId+'\')" />'+
										'<button style="'+style+'" onclick=";">'+firstname+'</button>'+
										'<label style="align:left;margin:5;font-size:16;color:#555555;">'+channelName+'</label>'+
									'</row>'+
								'</item>'+
							'</list>'));
			     	}else{
			     		$('content').add($C('<list>'+
							'<item>'+
								'<col><row><label style="align:center;">暂无相关记录</label></row></col>'+
							'</item>'+
						'</list>'));
			     	}
			     }else{
			     	$('content').add($C('<list>'+
						'<item>'+
							'<col><row><label style="align:center;">暂无相关记录</label></row></col>'+
						'</item>'+
					'</list>'));
			     }
			    $('content').hideTop(); 
			},function(error) {
			    if (error == 'timeout') {
			        hint('连接服务器超时！');
			    } else if (error == '404') {
			        hint('链接超时重新登录！');
			    } else if (error == '500') {
			        hint('内部服务器错误！');
			    } else {
			        hint('访问网络错误！错误代码:' + error);
			    }
		    });
		}
    ]]>
    </script> 
    <page>
       <title style="background:#3daffe;tint-color:white;">
            <left>
                <button role="back"/>
            </left>
            <center>
                <label style="color:#ffffff">订阅信息栏目</label>
            </center>
            <right>
                <button id="lab_saveMychannel" onclick="" style="font-size:18;color:#FFFFFF;">完成</button>
            </right>
        </title>
        <header>
			<row style="text-align:center; padding:0 0;">
				<input type="search" id="title" name="title" placeholder="请输入信息栏目查询" onclick="searchColumn()" style="height: 45;" value=""/>
			</row>
		</header>
        <content id="content" draggable="true">
        </content>
        
    </page>
</imag>